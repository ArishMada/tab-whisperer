const h="tw_open_",c=t=>`${h}${t}`;async function d(t,a){await chrome.storage.session.set({[c(t)]:a})}async function o(t){return!!(await chrome.storage.session.get(c(t)))[c(t)]}function n(t){return t?t.startsWith("chrome://")||t.startsWith("edge://")||t.startsWith("about://"):!1}chrome.action.onClicked.addListener(async t=>{if(t?.id){if(n(t.url)){await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}}if(t.windowId!==void 0){const a=await o(t.windowId);await d(t.windowId,!a)}}});chrome.runtime.onMessage.addListener((t,a,r)=>{if(t?.type==="CLOSE_SIDEBAR")return(async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e?.id){try{await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"})}catch{}e.windowId!==void 0&&await d(e.windowId,!1)}r({ok:!0})})(),!0;if(t?.type==="GET_TABS_SNAPSHOT")return(async()=>{const s=(await chrome.tabs.query({})).filter(i=>!n(i.url)).map(i=>({id:i.id,title:i.title||"",url:i.url||"",favIconUrl:i.favIconUrl}));r({tabs:s})})(),!0;if(t?.type==="GET_SAVED_TABS")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs");r({tabs:e??[]})})(),!0;if(t?.type==="SAVE_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),s=e??[];s.unshift(t.payload),await chrome.storage.local.set({savedTabs:s}),r({ok:!0})})(),!0;if(t?.type==="REMOVE_SAVED_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),s=e??[];await chrome.storage.local.set({savedTabs:s.filter(i=>i.id!==t.id)}),r({ok:!0})})(),!0});chrome.tabs.onActivated.addListener(async({tabId:t,windowId:a})=>{if(await o(a)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});chrome.tabs.onUpdated.addListener(async(t,a,r)=>{if(a.status==="complete"&&r.windowId!==void 0&&await o(r.windowId)&&!n(r.url)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});
