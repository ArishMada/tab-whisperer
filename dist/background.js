const w="savedTabs";async function v(){return(await chrome.storage.local.get(w))[w]??[]}async function m(t){await chrome.storage.local.set({[w]:t})}async function T(t,c){const a=(await v()).map(e=>e.group===t?{...e,group:c}:e);await m(a)}const b="tw_open_",h=t=>`${b}${t}`;async function f(t,c){await chrome.storage.session.set({[h(t)]:c})}async function y(t){return!!(await chrome.storage.session.get(h(t)))[h(t)]}function u(t){return t?t.startsWith("chrome://")||t.startsWith("edge://")||t.startsWith("about://"):!1}chrome.action.onClicked.addListener(async t=>{if(t?.id){if(u(t.url)){await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}}if(t.windowId!==void 0){const c=await y(t.windowId);await f(t.windowId,!c)}}});chrome.runtime.onMessage.addListener((t,c,o)=>{if(t?.type==="CLOSE_SIDEBAR")return(async()=>{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});if(a?.id){try{await chrome.tabs.sendMessage(a.id,{type:"TOGGLE_SIDEBAR"})}catch{}a.windowId!==void 0&&await f(a.windowId,!1)}o({ok:!0})})(),!0;if(t?.type==="GET_TABS_SNAPSHOT")return(async()=>{const e=(await chrome.tabs.query({})).filter(r=>!u(r.url)).map(r=>({id:r.id,title:r.title||"",url:r.url||"",favIconUrl:r.favIconUrl}));o({tabs:e})})(),!0;if(t?.type==="GET_SAVED_TABS")return(async()=>{const{savedTabs:a}=await chrome.storage.local.get("savedTabs");o({tabs:a??[]})})(),!0;if(t?.type==="SAVE_TAB")return(async()=>{const{savedTabs:a}=await chrome.storage.local.get("savedTabs"),e=a??[];e.unshift(t.payload),await chrome.storage.local.set({savedTabs:e}),o({ok:!0})})(),!0;if(t?.type==="REMOVE_SAVED_TAB")return(async()=>{const{savedTabs:a}=await chrome.storage.local.get("savedTabs"),e=a??[];await chrome.storage.local.set({savedTabs:e.filter(r=>r.id!==t.id)}),o({ok:!0})})(),!0;if(t?.type==="UPDATE_SAVED_TAB")return(async()=>{const{savedTabs:a}=await chrome.storage.local.get("savedTabs"),e=a??[],r=e.findIndex(s=>s.id===t.id);r>=0?(e[r]={...e[r],...t.patch??{}},await chrome.storage.local.set({savedTabs:e}),o({ok:!0,tab:e[r]})):o({ok:!1,error:"NOT_FOUND"})})(),!0;if(t?.type==="RENAME_GROUP")return(async()=>{const{from:a,to:e}=t;if(a==="Ungrouped"){o({ok:!1,error:"CANNOT_RENAME_UNGROUPED"});return}await T(a,e);const{savedTabs:r}=await chrome.storage.local.get("savedTabs");o({ok:!0,tabs:r??[]})})(),!0;if(t?.type==="DELETE_GROUP")return(async()=>{try{const{name:a,mode:e}=t,{savedTabs:r}=await chrome.storage.local.get("savedTabs"),s=r??[],l=i=>a==="Ungrouped"?!i.group:i.group===a,d=e==="remove"?s.filter(i=>!l(i)):s.map(i=>l(i)?{...i,group:void 0}:i);await chrome.storage.local.set({savedTabs:d}),o({ok:!0}),o({ok:!0,tabs:d})}catch(a){o({ok:!1,error:String(a)})}})(),!0;if(t?.type==="SAVE_ALL_IN_WINDOW")return(async()=>{const{windowId:a}=t,[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),r=a??e?.windowId;if(r==null){o({ok:!1,error:"NO_WINDOW"});return}const s=await chrome.tabs.query({windowId:r}),l=Date.now(),d=s.filter(n=>!u(n.url)).map(n=>({id:`${n.id}-${l}-${Math.random().toString(36).slice(2,7)}`,title:n.title||"(No title)",url:n.url||"",favIconUrl:n.favIconUrl,savedAt:l})),{savedTabs:i}=await chrome.storage.local.get("savedTabs"),g=i??[];await chrome.storage.local.set({savedTabs:[...d,...g]}),o({ok:!0,count:d.length})})(),!0;if(t?.type==="SAVE_TABS_BULK")return(async()=>{const{savedTabs:a}=await chrome.storage.local.get("savedTabs"),e=a??[],r=t.payload??[],s=[...r,...e];await chrome.storage.local.set({savedTabs:s}),o({ok:!0,count:r.length})})(),!0});chrome.tabs.onActivated.addListener(async({tabId:t,windowId:c})=>{if(await y(c)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});chrome.tabs.onUpdated.addListener(async(t,c,o)=>{if(c.status==="complete"&&o.windowId!==void 0&&await y(o.windowId)&&!u(o.url)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});
