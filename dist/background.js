const w="savedTabs";async function v(){return(await chrome.storage.local.get(w))[w]??[]}async function T(t){await chrome.storage.local.set({[w]:t})}async function S(t,n){const e=(await v()).map(a=>a.group===t?{...a,group:n}:a);await T(e)}const y="AIzaSyDsEzNjBJHwORJcUHyxOrvH6UmWBmZPgSc",_=`https://generativelanguage.googleapis.com/v1/models?key=${y}`,g=["models/gemini-1.5-flash-latest","models/gemini-1.5-flash","models/gemini-1.5-flash-8b-latest","models/gemini-1.5-flash-8b","models/gemini-1.5-pro-latest","models/gemini-1.5-pro","models/gemini-1.0-pro"];async function A(){const t=await fetch(_,{method:"GET"});if(!t.ok){const r=await t.text().catch(()=>"");throw new Error(`ListModels ${t.status}: ${r}`)}return(await t.json()).models??[]}function I(t){const n=new Set(t.filter(e=>e.supportedGenerationMethods?.includes("generateContent")).map(e=>e.name));for(const e of g){if(n.has(e))return e;if(e.endsWith("-latest")){const a=e.replace("-latest","");if(n.has(a))return a}}const r=t.find(e=>e.supportedGenerationMethods?.includes("generateContent"));if(!r)throw new Error("No Gemini model with generateContent is available for this API key/project.");return r.name}async function O(){const t=await A();return I(t)}async function f(t,n){const r=`https://generativelanguage.googleapis.com/v1/${t}:generateContent?key=${y}`,a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:n}]}]})});if(!a.ok){const i=await a.text().catch(()=>"");throw new Error(`Gemini v1 ${a.status}: ${i}`)}return(await a.json()).candidates?.[0]?.content?.parts?.map(i=>i.text??"").join("")??""}async function p(t,n){const e=`Summarize and group the following browser tabs by topic.

Tabs:
${t.map((o,s)=>`${s+1}. ${o.title} (${o.url})`).join(`
`)}

`+(n?`User request: ${n}`:"");let a=g[0];try{return await f(a,e)}catch(o){if(!(o instanceof Error&&/(^|[\s{"])404([\s}",]|$)/.test(o.message)&&/NOT_FOUND|is not found|not supported/.test(o.message)))throw o;return a=await O(),await f(a,e)}}const U="tw_open_",h=t=>`${U}${t}`;async function b(t,n){await chrome.storage.session.set({[h(t)]:n})}async function m(t){return!!(await chrome.storage.session.get(h(t)))[h(t)]}function d(t){return t?t.startsWith("chrome://")||t.startsWith("edge://")||t.startsWith("about://"):!1}chrome.action.onClicked.addListener(async t=>{if(t?.id){if(d(t.url)){await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}}if(t.windowId!==void 0){const n=await m(t.windowId);await b(t.windowId,!n)}}});chrome.runtime.onMessage.addListener((t,n,r)=>{if(t?.type==="CLOSE_SIDEBAR")return(async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e?.id){try{await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"})}catch{}e.windowId!==void 0&&await b(e.windowId,!1)}r({ok:!0})})(),!0;if(t?.type==="GET_TABS_SNAPSHOT")return(async()=>{const a=(await chrome.tabs.query({})).filter(o=>!d(o.url)).map(o=>({id:o.id,title:o.title||"",url:o.url||"",favIconUrl:o.favIconUrl}));r({tabs:a})})(),!0;if(t?.type==="GET_SAVED_TABS")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs");r({tabs:e??[]})})(),!0;if(t?.type==="SAVE_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[];a.unshift(t.payload),await chrome.storage.local.set({savedTabs:a}),r({ok:!0})})(),!0;if(t?.type==="AUTO_GROUP_TABS")return(async()=>{const{tabs:e}=t,a=`Categorize these tab titles into topic groups. Respond as JSON with { "Group Name": [titles...] }.

Tabs:
`+e.map(i=>i.title).join(`
`),o=e.map(i=>({title:i.title,url:i.url??""})),s=await p(o,a);r({ok:!0,groups:s})})(),!0;if(t?.type==="REMOVE_SAVED_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[];await chrome.storage.local.set({savedTabs:a.filter(o=>o.id!==t.id)}),r({ok:!0})})(),!0;if(t?.type==="UPDATE_SAVED_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[],o=a.findIndex(s=>s.id===t.id);o>=0?(a[o]={...a[o],...t.patch??{}},await chrome.storage.local.set({savedTabs:a}),r({ok:!0,tab:a[o]})):r({ok:!1,error:"NOT_FOUND"})})(),!0;if(t?.type==="RENAME_GROUP")return(async()=>{const{from:e,to:a}=t;if(e==="Ungrouped"){r({ok:!1,error:"CANNOT_RENAME_UNGROUPED"});return}await S(e,a);const{savedTabs:o}=await chrome.storage.local.get("savedTabs");r({ok:!0,tabs:o??[]})})(),!0;if(t?.type==="DELETE_GROUP")return(async()=>{try{const{name:e,mode:a}=t,{savedTabs:o}=await chrome.storage.local.get("savedTabs"),s=o??[],i=c=>e==="Ungrouped"?!c.group:c.group===e,u=a==="remove"?s.filter(c=>!i(c)):s.map(c=>i(c)?{...c,group:void 0}:c);await chrome.storage.local.set({savedTabs:u}),r({ok:!0}),r({ok:!0,tabs:u})}catch(e){r({ok:!1,error:String(e)})}})(),!0;if(t?.type==="SAVE_ALL_IN_WINDOW")return(async()=>{const{windowId:e}=t,[a]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=e??a?.windowId;if(o==null){r({ok:!1,error:"NO_WINDOW"});return}const s=await chrome.tabs.query({windowId:o}),i=Date.now(),u=s.filter(l=>!d(l.url)).map(l=>({id:`${l.id}-${i}-${Math.random().toString(36).slice(2,7)}`,title:l.title||"(No title)",url:l.url||"",favIconUrl:l.favIconUrl,savedAt:i})),{savedTabs:c}=await chrome.storage.local.get("savedTabs"),E=c??[];await chrome.storage.local.set({savedTabs:[...u,...E]}),r({ok:!0,count:u.length})})(),!0;if(t?.type==="SAVE_TABS_BULK")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[],o=t.payload??[],s=[...o,...a];await chrome.storage.local.set({savedTabs:s}),r({ok:!0,count:o.length})})(),!0;if(t?.type==="SUMMARIZE_TABS")return(async()=>{const{tabs:e,prompt:a}=t,o=e.map(s=>({title:s.title,url:s.url??""}));try{const s=await p(o,a);r({ok:!0,summary:s})}catch(s){r({ok:!1,error:String(s)})}})(),!0});chrome.tabs.onActivated.addListener(async({tabId:t,windowId:n})=>{if(await m(n)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});chrome.tabs.onUpdated.addListener(async(t,n,r)=>{if(n.status==="complete"&&r.windowId!==void 0&&await m(r.windowId)&&!d(r.url)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});
