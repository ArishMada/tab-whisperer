const n="savedTabs";async function f(){return(await chrome.storage.local.get(n))[n]??[]}async function p(t){await chrome.storage.local.set({[n]:t})}async function g(t,s){const e=(await f()).map(a=>a.group===t?{...a,group:s}:a);await p(e)}const m="tw_open_",d=t=>`${m}${t}`;async function y(t,s){await chrome.storage.session.set({[d(t)]:s})}async function u(t){return!!(await chrome.storage.session.get(d(t)))[d(t)]}function l(t){return t?t.startsWith("chrome://")||t.startsWith("edge://")||t.startsWith("about://"):!1}chrome.action.onClicked.addListener(async t=>{if(t?.id){if(l(t.url)){await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{await chrome.windows.create({url:chrome.runtime.getURL("sidebar.html"),type:"popup",width:420,height:700});return}}if(t.windowId!==void 0){const s=await u(t.windowId);await y(t.windowId,!s)}}});chrome.runtime.onMessage.addListener((t,s,o)=>{if(t?.type==="CLOSE_SIDEBAR")return(async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e?.id){try{await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"})}catch{}e.windowId!==void 0&&await y(e.windowId,!1)}o({ok:!0})})(),!0;if(t?.type==="GET_TABS_SNAPSHOT")return(async()=>{const a=(await chrome.tabs.query({})).filter(r=>!l(r.url)).map(r=>({id:r.id,title:r.title||"",url:r.url||"",favIconUrl:r.favIconUrl}));o({tabs:a})})(),!0;if(t?.type==="GET_SAVED_TABS")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs");o({tabs:e??[]})})(),!0;if(t?.type==="SAVE_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[];a.unshift(t.payload),await chrome.storage.local.set({savedTabs:a}),o({ok:!0})})(),!0;if(t?.type==="REMOVE_SAVED_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[];await chrome.storage.local.set({savedTabs:a.filter(r=>r.id!==t.id)}),o({ok:!0})})(),!0;if(t?.type==="UPDATE_SAVED_TAB")return(async()=>{const{savedTabs:e}=await chrome.storage.local.get("savedTabs"),a=e??[],r=a.findIndex(i=>i.id===t.id);r>=0?(a[r]={...a[r],...t.patch??{}},await chrome.storage.local.set({savedTabs:a}),o({ok:!0,tab:a[r]})):o({ok:!1,error:"NOT_FOUND"})})(),!0;if(t?.type==="RENAME_GROUP")return(async()=>{const{from:e,to:a}=t;await g(e,a);const{savedTabs:r}=await chrome.storage.local.get("savedTabs");o({ok:!0,tabs:r??[]})})(),!0;if(t?.type==="DELETE_GROUP")return(async()=>{try{const{name:e,mode:a}=t,{savedTabs:r}=await chrome.storage.local.get("savedTabs"),i=r??[],w=c=>e==="Ungrouped"?!c.group:c.group===e,h=a==="remove"?i.filter(c=>!w(c)):i.map(c=>w(c)?{...c,group:void 0}:c);await chrome.storage.local.set({savedTabs:h}),o({ok:!0,tabs:h})}catch(e){o({ok:!1,error:String(e)})}})(),!0});chrome.tabs.onActivated.addListener(async({tabId:t,windowId:s})=>{if(await u(s)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});chrome.tabs.onUpdated.addListener(async(t,s,o)=>{if(s.status==="complete"&&o.windowId!==void 0&&await u(o.windowId)&&!l(o.url)){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch{}try{await chrome.tabs.sendMessage(t,{type:"ENSURE_SIDEBAR"})}catch{}}});
